{{ template "header" . }}

<div class="h-full flex flex-col p-6 gap-6">
    <header class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-white">Manajemen Pengguna</h2>
            <p class="text-text-secondary">Kelola operator dan akses stasiun timbangan</p>
        </div>
        <button onclick="openUserModal()" class="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded-lg font-bold flex items-center gap-2">
            <span class="material-symbols-outlined">add</span> Tambah Pengguna
        </button>
    </header>

    <!-- User List -->
    <div class="bg-surface-dark border border-border-dark rounded-xl overflow-hidden flex-1">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-card-dark text-text-secondary text-sm border-b border-border-dark">
                    <th class="p-4 font-bold">Username</th>
                    <th class="p-4 font-bold">Nama Lengkap</th>
                    <th class="p-4 font-bold">Role</th>
                    <th class="p-4 font-bold">Akses Timbangan</th>
                    <th class="p-4 font-bold text-right">Aksi</th>
                </tr>
            </thead>
            <tbody id="user-table-body" class="text-white text-sm">
                <!-- Data populated via JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="user-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
    <div class="bg-surface-dark border border-border-dark rounded-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold text-white mb-4">Data Pengguna</h3>
        <form id="user-form" class="space-y-4">
            <input type="hidden" name="id" id="user-id">

            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Username</label>
                <input type="text" name="username" id="user-username" class="w-full bg-background-dark border border-border-dark rounded px-3 py-2 text-white" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Password</label>
                <input type="password" name="password" id="user-password" class="w-full bg-background-dark border border-border-dark rounded px-3 py-2 text-white" placeholder="Biarkan kosong jika tidak diubah">
            </div>
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Nama Lengkap</label>
                <input type="text" name="full_name" id="user-fullname" class="w-full bg-background-dark border border-border-dark rounded px-3 py-2 text-white" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Role</label>
                <select name="role" id="user-role" class="w-full bg-background-dark border border-border-dark rounded px-3 py-2 text-white">
                    <option value="operator">Operator</option>
                    <option value="admin">Admin</option>
                </select>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeUserModal()" class="px-4 py-2 text-text-secondary hover:text-white">Batal</button>
                <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded font-bold">Simpan</button>
            </div>
        </form>
    </div>
</div>

<!-- Access Assignment Modal -->
<div id="access-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
    <div class="bg-surface-dark border border-border-dark rounded-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold text-white mb-4">Akses Timbangan</h3>
        <p class="text-sm text-text-secondary mb-4">Pilih timbangan yang dapat diakses oleh pengguna ini.</p>

        <form id="access-form">
            <input type="hidden" id="access-user-id">
            <div id="station-list" class="space-y-2 mb-6">
                <!-- Checkboxes populated via JS -->
            </div>

            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeAccessModal()" class="px-4 py-2 text-text-secondary hover:text-white">Batal</button>
                <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary-hover text-white rounded font-bold">Simpan Akses</button>
            </div>
        </form>
    </div>
</div>

<script>
// Trigger immediately for HTMX swaps
loadUsers();
loadStationsForModal();

async function loadUsers() {
    const res = await fetch('/api/users');
    const users = await res.json();
    const tbody = document.getElementById('user-table-body');
    tbody.innerHTML = '';

    users.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = "border-b border-border-dark hover:bg-white/5 transition-colors";
        tr.innerHTML = `
            <td class="p-4">${user.username}</td>
            <td class="p-4">${user.full_name}</td>
            <td class="p-4">
                <span class="px-2 py-1 rounded text-xs font-bold ${user.role === 'admin' ? 'bg-primary/20 text-primary' : 'bg-white/10 text-white'}">${user.role.toUpperCase()}</span>
            </td>
            <td class="p-4">
                <button onclick="openAccessModal('${user.ID}')" class="text-primary hover:underline text-xs">Atur Akses</button>
            </td>
            <td class="p-4 text-right">
                <button onclick="deleteUser('${user.ID}')" class="text-red-500 hover:text-red-400">
                    <span class="material-symbols-outlined text-sm">delete</span>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function openUserModal() {
    document.getElementById('user-form').reset();
    document.getElementById('user-id').value = '';
    document.getElementById('user-modal').classList.remove('hidden');
    document.getElementById('user-modal').classList.add('flex');
}

function closeUserModal() {
    document.getElementById('user-modal').classList.add('hidden');
    document.getElementById('user-modal').classList.remove('flex');
}

document.getElementById('user-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);

    // Only creating new users supported for now via UI simplicity
    if(!data.password && !data.id) {
        alert("Password wajib diisi untuk user baru");
        return;
    }

    // Remove empty ID to prevent JSON unmarshal error on backend
    if (!data.id) {
        delete data.id;
    }

    const res = await fetch('/api/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });

    if(res.ok) {
        closeUserModal();
        loadUsers();
    } else {
        alert("Gagal menyimpan");
    }
});

async function deleteUser(id) {
    if(!confirm('Hapus user ini?')) return;
    await fetch('/api/users/'+id, { method: 'DELETE' });
    loadUsers();
}

// Access Management
let allStations = [];

async function loadStationsForModal() {
    const res = await fetch('/api/stations');
    allStations = await res.json();
}

async function openAccessModal(userId) {
    document.getElementById('access-user-id').value = userId;

    // Fetch current assignments
    const res = await fetch(`/api/users/${userId}/assignments`);
    const assignments = await res.json();
    const assignedIds = assignments.map(a => a.weighing_station_id);

    const container = document.getElementById('station-list');
    container.innerHTML = '';

    allStations.forEach(st => {
        const div = document.createElement('div');
        div.className = "flex items-center gap-3 p-3 border border-border-dark rounded hover:bg-white/5";
        div.innerHTML = `
            <input type="checkbox" name="station_ids" value="${st.ID}" ${assignedIds.includes(st.ID) ? 'checked' : ''} class="w-4 h-4 rounded bg-background-dark border-border-dark text-primary focus:ring-primary">
            <div>
                <div class="font-bold text-white text-sm">${st.name}</div>
                <div class="text-xs text-text-secondary">${st.scale_port}</div>
            </div>
        `;
        container.appendChild(div);
    });

    document.getElementById('access-modal').classList.remove('hidden');
    document.getElementById('access-modal').classList.add('flex');
}

function closeAccessModal() {
    document.getElementById('access-modal').classList.add('hidden');
    document.getElementById('access-modal').classList.remove('flex');
}

document.getElementById('access-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const userId = document.getElementById('access-user-id').value;
    const checkboxes = document.querySelectorAll('input[name="station_ids"]:checked');
    const stationIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    await fetch(`/api/users/${userId}/assignments`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ station_ids: stationIds })
    });

    closeAccessModal();
});
</script>

{{ template "footer" . }}
