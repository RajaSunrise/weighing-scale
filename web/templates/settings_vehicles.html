{{ template "header" . }}

<div class="h-full flex flex-col p-6 gap-6">
    <header class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-white">Vehicle Management</h2>
            <p class="text-text-secondary">Register trucks, heavy equipment, and drivers</p>
        </div>
        <button onclick="document.getElementById('addVehicleModal').classList.remove('hidden')" class="px-4 py-2 bg-primary hover:bg-primary-hover text-white font-bold rounded-lg transition-colors flex items-center gap-2">
            <span class="material-symbols-outlined">add</span> Add Vehicle
        </button>
    </header>

    <!-- Vehicles Table -->
    <div class="bg-surface-dark border border-border-dark rounded-xl flex-1 overflow-hidden flex flex-col">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-card-dark text-text-secondary font-medium border-b border-border-dark">
                    <tr>
                        <th class="px-6 py-4">Plate Number</th>
                        <th class="px-6 py-4">Driver Name</th>
                        <th class="px-6 py-4">Company</th>
                        <th class="px-6 py-4 text-right">Default Tare (kg)</th>
                        <th class="px-6 py-4 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="vehicleTableBody" class="divide-y divide-border-dark">
                    <!-- Loaded via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Vehicle Modal -->
<div id="addVehicleModal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-surface-dark border border-border-dark rounded-xl w-full max-w-lg p-6 shadow-2xl">
        <h3 class="text-xl font-bold text-white mb-4">Register New Vehicle</h3>
        <form id="addVehicleForm" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Plate Number</label>
                <input type="text" name="plate_number" class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary font-mono uppercase" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Driver Name</label>
                <input type="text" name="driver_name" class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Company / Owner</label>
                <input type="text" name="owner_company" class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary">
            </div>
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Default Tare Weight (kg)</label>
                <input type="number" name="default_tare" class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary">
                <p class="text-xs text-text-secondary mt-1">Optional. Will be auto-filled in weighing if set.</p>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="document.getElementById('addVehicleModal').classList.add('hidden')" class="px-4 py-2 text-text-secondary hover:text-white">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-primary hover:bg-primary-hover text-white font-bold rounded-lg">Save Vehicle</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadVehicles);

async function loadVehicles() {
    const res = await fetch('/settings/api/vehicles');
    const data = await res.json();
    const tbody = document.getElementById('vehicleTableBody');
    tbody.innerHTML = '';

    data.forEach(v => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-card-hover transition-colors';
        tr.innerHTML = `
            <td class="px-6 py-4 font-mono font-bold text-white">${v.plate_number}</td>
            <td class="px-6 py-4">${v.driver_name}</td>
            <td class="px-6 py-4 text-text-secondary">${v.owner_company}</td>
            <td class="px-6 py-4 text-right font-mono">${v.default_tare}</td>
            <td class="px-6 py-4 text-center">
                <button onclick="deleteVehicle(${v.ID})" class="text-red-500 hover:text-red-400 material-symbols-outlined text-sm">delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

document.getElementById('addVehicleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    // Convert tare to number
    data.default_tare = parseFloat(data.default_tare) || 0;

    const res = await fetch('/settings/api/vehicles', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if(res.ok) {
        document.getElementById('addVehicleModal').classList.add('hidden');
        e.target.reset();
        loadVehicles();
    } else {
        alert("Failed to save. Plate number might be duplicate.");
    }
});

async function deleteVehicle(id) {
    if(!confirm("Are you sure?")) return;
    await fetch('/settings/api/vehicles/' + id, { method: 'DELETE' });
    loadVehicles();
}
</script>

{{ template "footer" . }}
