{{ template "header" . }}

<div class="h-full flex flex-col p-6 gap-6">
    <header class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-white">Laporan Transaksi</h2>
            <p class="text-text-secondary">Riwayat penimbangan dan ekspor data</p>
        </div>

        <!-- Date Filter -->
        <form method="GET" action="/reports" class="flex gap-4 items-end">
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Dari Tanggal</label>
                <input type="date" name="start_date" value="{{ .StartDate }}" class="bg-background-dark border border-border-dark rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-primary">
            </div>
            <div>
                <label class="block text-xs font-bold text-text-secondary mb-1">Sampai Tanggal</label>
                <input type="date" name="end_date" value="{{ .EndDate }}" class="bg-background-dark border border-border-dark rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-primary">
            </div>
            <button type="submit" class="px-4 py-2 bg-surface-dark border border-border-dark hover:bg-card-hover text-white text-sm font-bold rounded-lg transition-colors">
                Filter
            </button>
            <button type="button" onclick="window.print()" class="px-4 py-2 bg-primary hover:bg-primary-hover text-white text-sm font-bold rounded-lg transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">print</span> Cetak
            </button>
            <button type="button" onclick="toggleCharts()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold rounded-lg transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">monitoring</span> Grafik
            </button>
        </form>
    </header>

    <!-- Chart Section (Hidden by default) -->
    <div id="chart-section" class="hidden flex-col gap-4 bg-surface-dark border border-border-dark rounded-xl p-6 no-print">
        <div class="flex justify-between items-center border-b border-border-dark pb-4">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-500">analytics</span>
                Analisa Trend Penimbangan
            </h3>
            <div class="flex gap-2 bg-background-dark rounded-lg p-1">
                <button onclick="loadChart('daily')" id="btn-daily" class="px-3 py-1 rounded text-xs font-bold text-text-secondary hover:bg-white/10">Harian</button>
                <button onclick="loadChart('weekly')" id="btn-weekly" class="px-3 py-1 rounded text-xs font-bold text-text-secondary hover:bg-white/10">Mingguan</button>
                <button onclick="loadChart('monthly')" id="btn-monthly" class="px-3 py-1 rounded text-xs font-bold text-text-secondary hover:bg-white/10">Bulanan</button>
            </div>
        </div>
        <div class="h-64 w-full relative">
            <canvas id="weightChart"></canvas>
        </div>
    </div>

    <style>
        @media print {
            @page {
                size: landscape;
                margin: 12mm 10mm;
            }
            
            /* Hide all non-essential elements */
            body * {
                visibility: hidden;
            }
            
            /* Only show the printable area */
            .print-area, .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
            }
            
            /* Reset body */
            body {
                background-color: white !important;
                color: black !important;
                font-family: 'Arial', 'Helvetica', sans-serif !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Hide navigation and sidebar */
            nav, aside, header.flex, form, button, .logo-brand, .logo-user, .no-print {
                display: none !important;
                visibility: hidden !important;
            }

            /* Print Header - appears on every page */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 15px;
                padding-bottom: 12px;
                border-bottom: 3px solid #000;
            }
            
            .print-header h1 {
                font-size: 16pt;
                font-weight: bold;
                margin: 0 0 5px 0;
                color: #000;
            }
            
            .print-header p {
                font-size: 10pt;
                margin: 0;
                color: #333;
            }

            /* Table Container */
            .table-container {
                width: 100%;
                overflow: visible !important;
            }

            /* Table Styling */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 0 !important;
                table-layout: fixed;
                page-break-inside: auto;
            }
            
            /* Strong borders */
            th, td {
                border: 2px solid #000 !important;
                padding: 6px 4px !important;
                font-size: 9pt !important;
                color: #000 !important;
                vertical-align: middle !important;
                text-align: left !important;
                word-wrap: break-word;
            }
            
            /* Header styling - repeat on every page */
            thead {
                display: table-header-group;
                background-color: #e0e0e0 !important;
            }
            
            thead th {
                background-color: #e0e0e0 !important;
                font-weight: bold !important;
                font-size: 9pt !important;
                color: #000 !important;
                border: 2px solid #000 !important;
                padding: 8px 4px !important;
                text-transform: uppercase;
            }
            
            /* Allow row breaks across pages */
            tbody {
                display: table-row-group;
            }
            
            tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            
            tbody tr {
                border: 2px solid #000 !important;
            }
            
            /* Alternating row colors */
            tbody tr:nth-child(even):not(.total-row) {
                background-color: #f5f5f5 !important;
            }
            
            tbody tr:nth-child(odd):not(.total-row) {
                background-color: #ffffff !important;
            }
            
            /* Total row styling - ONLY on last page, NOT repeated */
            tfoot {
                display: table-footer-group;
                page-break-inside: avoid !important;
            }
            
            tr.total-row {
                background-color: #d9d9d9 !important;
                font-weight: bold !important;
                border-top: 4px double #000 !important;
                border-bottom: 4px double #000 !important;
                page-break-before: avoid !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            tr.total-row td {
                font-size: 10pt !important;
                padding: 10px 4px !important;
                border: 2px solid #000 !important;
                font-weight: bold !important;
            }
            
            /* Column alignment */
            .text-right {
                text-align: right !important;
            }
            
            .text-center {
                text-align: center !important;
            }
            
            /* Hide action column */
            th:last-child, td:last-child {
                display: none !important;
            }
            
            /* Specific column widths - optimized for landscape */
            th:nth-child(1), td:nth-child(1) { width: 9%; }  /* Waktu */
            th:nth-child(2), td:nth-child(2) { width: 11%; } /* No. Tiket */
            th:nth-child(3), td:nth-child(3) { width: 9%; }  /* No. Polisi */
            th:nth-child(4), td:nth-child(4) { width: 15%; } /* Supir */
            th:nth-child(5), td:nth-child(5) { width: 15%; } /* Muatan */
            th:nth-child(6), td:nth-child(6) { width: 13%; } /* Gross */
            th:nth-child(7), td:nth-child(7) { width: 13%; } /* Tare */
            th:nth-child(8), td:nth-child(8) { width: 15%; } /* Netto */
            
            /* Font styles */
            .font-mono {
                font-family: 'Courier New', monospace !important;
            }
            
            /* Remove backgrounds and borders from containers */
            .bg-surface-dark, .border, .rounded-xl, .overflow-x-auto, .overflow-hidden {
                background: none !important;
                border: none !important;
                border-radius: 0 !important;
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
            }
            
            /* Empty state should not print */
            .text-center span.material-symbols-outlined {
                display: none !important;
            }
        }
    </style>

    <!-- Report Table -->
    <div class="bg-surface-dark border border-border-dark rounded-xl flex-1 overflow-hidden flex flex-col print-area">
        <!-- Print Header (only visible when printing) -->
        <div class="print-header" style="display: none;">
            <h1>LAPORAN TRANSAKSI PENIMBANGAN</h1>
            <p>Periode: {{ .StartDate }} s/d {{ .EndDate }}</p>
        </div>
        
        <div class="overflow-x-auto h-full table-container">
            <table class="w-full text-left text-sm">
                <thead class="bg-card-dark text-text-secondary font-medium border-b border-border-dark sticky top-0">
                    <tr>
                        <th class="px-6 py-4">Waktu</th>
                        <th class="px-6 py-4">No. Tiket</th>
                        <th class="px-6 py-4">No. Polisi</th>
                        <th class="px-6 py-4">Supir</th>
                        <th class="px-6 py-4">Muatan</th>
                        <th class="px-6 py-4 text-right">Gross (kg)</th>
                        <th class="px-6 py-4 text-right">Tare (kg)</th>
                        <th class="px-6 py-4 text-right">Netto (kg)</th>
                        <th class="px-6 py-4 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border-dark overflow-y-auto">
                    {{ range .Records }}
                    <tr class="hover:bg-card-hover transition-colors">
                        <td class="px-6 py-4 text-text-secondary whitespace-nowrap">{{ .WeighedAt.Format "02 Jan 15:04" }}</td>
                        <td class="px-6 py-4 font-mono text-xs whitespace-nowrap">{{ .TicketNumber }}</td>
                        <td class="px-6 py-4 font-medium text-white whitespace-nowrap">{{ .PlateNumber }}</td>
                        <td class="px-6 py-4">{{ .DriverName }}</td>
                        <td class="px-6 py-4">{{ .Product }}</td>
                        <td class="px-6 py-4 text-right font-mono whitespace-nowrap">{{ printf "%.0f" .GrossWeight }}</td>
                        <td class="px-6 py-4 text-right font-mono text-text-secondary whitespace-nowrap">{{ printf "%.0f" .TareWeight }}</td>
                        <td class="px-6 py-4 text-right font-mono font-bold text-success whitespace-nowrap">{{ printf "%.0f" .NetWeight }}</td>
                        <td class="px-6 py-4 text-center">
                            {{ if .InvoicePath }}
                            <a href="/{{ .InvoicePath }}" target="_blank" class="inline-flex items-center justify-center w-8 h-8 rounded hover:bg-white/10 text-primary" title="Lihat PDF">
                                <span class="material-symbols-outlined text-lg">description</span>
                            </a>
                            {{ end }}
                        </td>
                    </tr>
                    {{ else }}
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-text-secondary">
                            <span class="material-symbols-outlined text-4xl mb-2">inbox</span>
                            <p>Tidak ada data ditemukan untuk periode ini.</p>
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
                <!-- Total Row - ONLY appears at the END (last page only) -->
                {{ if gt (len .Records) 0 }}
                <tfoot>
                    <tr class="bg-primary/20 font-bold border-t-2 border-primary total-row">
                        <td colspan="7" class="px-6 py-4 text-right text-primary-light">TOTAL NETTO (kg)</td>
                        <td class="px-6 py-4 text-right font-mono text-primary text-lg">{{ printf "%.0f" .TotalNetWeight }}</td>
                        <td class="px-6 py-4"></td>
                    </tr>
                </tfoot>
                {{ end }}
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Update document title for unique filename when printing
    (function() {
        const start = "{{ .StartDate }}";
        const end = "{{ .EndDate }}";
        document.title = `Laporan_Transaksi_${start}_sd_${end}`;
    })();

    let myChart = null;

    function toggleCharts() {
        const sec = document.getElementById('chart-section');
        if (sec.classList.contains('hidden')) {
            sec.classList.remove('hidden');
            sec.classList.add('flex');
            loadChart('daily');
        } else {
            sec.classList.add('hidden');
            sec.classList.remove('flex');
        }
    }

    async function loadChart(period) {
        // Update Active Button
        ['daily','weekly','monthly'].forEach(p => {
            const btn = document.getElementById(`btn-${p}`);
            if(p === period) {
                btn.classList.add('bg-primary', 'text-white');
                btn.classList.remove('text-text-secondary');
            } else {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('text-text-secondary');
            }
        });

        try {
            const res = await fetch(`/api/reports/charts?period=${period}`);
            const data = await res.json();
            renderChart(data.labels, data.data);
        } catch(e) {
            console.error(e);
        }
    }

    function renderChart(labels, data) {
        const ctx = document.getElementById('weightChart').getContext('2d');

        if (myChart) {
            myChart.destroy();
        }

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(25, 109, 236, 0.5)'); // Primary color
        gradient.addColorStop(1, 'rgba(25, 109, 236, 0)');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Berat Bersih (kg)',
                    data: data,
                    borderColor: '#196DEC',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#196DEC',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#9ca3af'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#9ca3af'
                        }
                    }
                }
            }
        });
    }
</script>

{{ template "footer" . }}